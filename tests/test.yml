---

- hosts: all
  gather_facts: false
  tasks:
    - name: 'ensure python2 is present'
      raw: 'which python || apt-get install -y python python-simplejson'
      changed_when: false

- hosts: all
  remote_user: root
  vars:
    vault_repo_password: 'foobar'
    restic_jobs:
      - at: '0 6  * * *'
        type: 'db_mysql'
        arg: 'blog'
      - at: '0 7  * * *'
        type: 'db_mysql'
        arg: 'feedback'
    restic_jobs_raw:
      - command: 'restic backup /var'
        at: '0 4  * * *'
      - command: 'restic backup /home'
        at: '0 3  * * *'
        user: 'restic'

  roles:
    - ansible-restic

  tasks:
    - name: run `restic version`
      command: restic version
      register: cmd_restic_version
      changed_when: false

    - name: ensure versions match
      assert:
        that:
          - "restic_version in cmd_restic_version.stdout"
        msg: 'restic version does not match to that in restic_version'
